---
- hosts: all
  tasks: 
    - name: Install Chrony
      apt:
        pkg:
          - chrony
    - name: Set Timezone
      community.general.timezone:
        name: Europe/Moscow
    - name: Set Primary ntp server
      lineinfile:
        path: /etc/chrony/chrony.conf
        regexp: '^pool'
        line: pool 192.168.100.200 iburst
    - name: Resrart Chrony
      service:
        name: chrony
        state: restarted

- hosts: routers
  vars_files: 
    - ./vars.yaml
  tasks: 
    - name: Install package
      apt:
        pkg:
          - cowsay
          - strongswan
- hosts: localhost
  roles:
    - dnsserver
    - ntp

- hosts: 192.168.100.254
  vars_files:
    - ./vars.yaml
  tasks:    
    - name: Check Hostname
      command: hostname
      register: hostname_rtr_l
    - name: Set Hostname
      hostname:
        name: "{{ router_left }}"
      when: hostname_rtr_l.stdout != "{{ router_left }}"
    - name: After change hostname reboot machine
      reboot:
      when: hostname_rtr_l.stdout != "{{ router_left }}"
    - name: Create Nftables
      template:
        src: ./nftables_RTR-L.conf
        dest: /etc/nftables.conf
      notify:
            - restart
    - name: Copy GRE-script
      copy:
        src: ./ipsec/RTR-L/gre_RTR-L.up
        dest: /etc/gre_RTR-L.up
        mode: "0755"
    - name: Launch script for GRE
      command: /bin/bash /etc/gre_RTR-L.up
      ignore_errors: true

    - name: set change in crontab
      lineinfile:
        path: /etc/crontab
        line: "@reboot root /etc/gre_RTR-L.up"
        insertafter: EOF
    - name: Chech crontab correct
      fetch:
        src: "/etc/crontab"
        dest: "crontab_RTR-L"
    - name: Download ipsec.conf
      copy:
        src: ./ipsec/RTR-L/ipsec.conf
        dest: /etc/ipsec.conf
        mode: "0755"
    - name: Download ipsec.secret
      copy:
        src: ./ipsec/RTR-L/ipsec.secret
        dest: /etc/ipsec.secrets
        mode: "0755"
    - name: Start Strongswan
      service: 
          name: ipsec
          state: restarted

  handlers:
    - name: restart
      service:
        name: nftables
        state: restarted    

- hosts: 192.168.100.100
  vars_files:
    - ./vars.yaml
    - ./secret.yml
  tasks:    
    - name: Check Hostname
      command: hostname
      register: hostname_web_l
    - name: Set Hostname
      hostname:
        name: "{{ left_web_server }}"
      when: hostname_web_l.stdout != "{{ left_web_server }}"
    - name: After change hostname reboot machine
      reboot:
      when: hostname_web_l.stdout != "{{ left_web_server }}"
    - name: Create user with password
      user:
        name: "{{ username }}"
        password: "{{ password }}"
        shell: /bin/bash

- hosts: 5.5.5.100
  vars_files:
    - ./vars.yaml
  tasks:    
    - name: Check Hostname
      command: hostname
      register: hostname_rtr_r
    - name: Set Hostname
      hostname:
        name: "{{ router_right }}"
      when: hostname_rtr_r.stdout != "{{ router_right }}"
    - name: After change hostname reboot machine
      reboot:
      when: hostname_rtr_r.stdout != "{{ router_right }}" 
    - name: Set nftables rules
      copy:
        src: ./nftables_RTR-R.conf
        dest: /etc/nftables.conf
        mode: "0755"
    - name: Resrart Nftables
      service:
        name: nftables
        state: restarted
    - name: Add file
      blockinfile: 
        path: /etc/gre_RTR-R.up
        block: | 
          ip tunnel add tun1 mode gre local 5.5.5.100 remote 4.4.4.100 ttl 64
          ip link set tun1 up
          ip addr add 10.5.5.2/30 dev tun1
          ip route add 192.168.100.0/24 via 10.5.5.1
        state: present
        create: yes
    - name: Launch GRE
      command: /bin/bash /etc/gre_RTR-R.up
      ignore_errors: true
    - name: Configure crontab
      lineinfile:
        path: /etc/crontab
        line: "@reboot root /etc/gre_RTR-R.up"
        insertafter: EOF
    - name: Download ipsec.conf
      copy:
        src: ./ipsec/RTR-R/ipsec.conf
        dest: /etc/ipsec.conf
        mode: "0755"
    - name: Download ipsec.secret
      copy:
        src: ./ipsec/RTR-R/ipsec.secret
        dest: /etc/ipsec.secrets
        mode: "0755"
    - name: Start Strongswan
      service: 
        name: ipsec
        state: restarted

- hosts: 172.16.100.100
  vars_files:
    - ./vars.yaml
    - ./secret.yml
  tasks:    
    - name: Check Hostname
      command: hostname
      register: hostname_web_r
    - name: Set Hostname
      hostname:
        name: "{{ right_web_server }}"
      when: hostname_web_r.stdout != "{{ right_web_server }}"
    - name: After change hostname reboot machine
      reboot:
      when: hostname_web_r.stdout != "{{ right_web_server }}"

